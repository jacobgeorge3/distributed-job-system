services:
  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"

  api:
    build: ./api-service
    container_name: api-service
    ports:
      - "5001:5000"
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 2s
      retries: 5

  worker:
    build: ./worker-service
    container_name: worker-service
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; redis.Redis(host='redis').ping()"]
      interval: 10s
      timeout: 2s
      retries: 5

  reconciler:
    build: ./reconciler-service
    container_name: reconciler-service
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      STALE_THRESHOLD_SECONDS: ${STALE_THRESHOLD_SECONDS:-300}
      RECONCILER_INTERVAL: ${RECONCILER_INTERVAL:-60}
    depends_on:
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; redis.Redis(host='redis').ping()"]
      interval: 30s
      timeout: 2s
      retries: 3


